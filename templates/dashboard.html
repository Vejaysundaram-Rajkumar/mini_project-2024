<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='dash.css') }}">
    <title>Bloodline</title>
</head>
<body>
    
    <div class="gradient-background">
    <div class="profile-dropdown">
        <img src="{{ url_for('static', filename='profile_icon.png') }}" alt="Profile Icon" width="30" height="30">
        <div class="profile-dropdown-content">
            <a href="/profile">Profile</a>
            <a href="/logout">Logout</a>
        </div>
    </div>
    <div id="requestBloodModal" class="modal">

        <!-- Modal content -->
        <div class="modal-content">
            <span class="close">&times;</span>
            <form id="bloodRequestForm">
                <label for="bloodType">Select Blood Type:</label>
                <select id="bloodType" name="bloodType">
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <!-- Add other blood types here -->
                </select>
                <button type="submit">Submit</button>
            </form>
        </div>

    </div>
    <h1 class="welcome">Welcome! {{current_user}}</h1>
<div class="get-started">
    <button onclick="location.href='/create'">Create a camp</button>
    <button  id="requestBloodBtn">Request Blood</button>
</div>
<script>
// Get the modal
var modal = document.getElementById("requestBloodModal");

// Get the button that opens the modal
var btn = document.getElementById("requestBloodBtn");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];

// Variable to track if a request is allowed
var isRequestAllowed = true;

// Function to disable the request for 5 minutes
function disableRequestForFiveMinutes() {
    isRequestAllowed = false;
    setTimeout(function() {
        isRequestAllowed = true;
    }, 300000); // 300000 milliseconds = 5 minutes
}

// When the user clicks the button, open the modal or show alert
btn.onclick = function() {
    if (isRequestAllowed) {
        modal.style.display = "block";
    } else {
        alert("You can make another request after 5 minutes.");
    }
}

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
    modal.style.display = "none";
}

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = "none";
    }
}

function sendBloodRequest(position, bloodType) {
    const location = {
        latitude: position.coords.latitude,
        longitude: position.coords.longitude
    };

    fetch('/request_blood', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ location: location, bloodType: bloodType })
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        disableRequestForFiveMinutes(); // Disable the request for 5 minutes after successful request
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// Handle form submission
document.getElementById('bloodRequestForm').addEventListener('submit', function(event) {
    event.preventDefault();
    var bloodType = document.getElementById('bloodType').value;
    // Get user's current location using Geolocation API
    
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            sendBloodRequest(position, bloodType);
        });
    } else {
        alert('Geolocation is not supported by this browser.');
    }
    modal.style.display = "none"; // Close the modal after submission
});

</script>



</body>
</html>